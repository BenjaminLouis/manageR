---
lang: fr
output: 
  weasydoc::hpdf_document_base:
    engine: "weasyprint"
    keep_html: true
    css: "template_style.css"
    fig_caption: false
params:
  info:
    value:
      date: NA
      doc: "Facture"
      ndoc: "N0001"
      nclient: "C0001"
  name: "Company name<br/> Services"
  config:
    value:
      address1: "1 rue fictive"
      address2: "test"
      postal_code: "01000"
      city: "Testcity"
      mobile: "+33(0)6 00 00 00 00"
      e_mail: "contact@email.com"
      web: "www.siteweb.com"
      siret: "xxxxxxxxxxxxxxxxxx"
  client:
    value:
      firstname: "firstname"
      name: "name"
      company: NA
      department: NA
      address1: "1 rue fictive"
      address2: "test"
      postal_code: "01000"
      city: "Testcity"
      mobile: "+33(0)6 00 00 00 00"
      e_mail: "contact@email.com"
  billing:
    value:
      company: NA
      department: NA
      siret: NA
      address1: "1 rue fictive"
      address2: "test"
      postal_code: "01000"
      city: "Testcity"
      mobile: "+33(0)6 00 00 00 00"
      e_mail: "contact@email.com"
---

```{r setup, include=FALSE}
library(htmltools)
library(glue)
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
library(fontawesome)
tagList(rmarkdown::html_dependency_font_awesome())
if (Sys.info()["sysname"] == "Linux") {
  insert_fa <- function(x) { glue("<i class=\"fa fa-{x}\"></i>") }
}
if (Sys.info()["sysname"] == "Windows") {
  insert_fa <- function(x) { 
    fa_r <- fa(glue("{x}"))
    fa_r_raw <- charToRaw(fa_r)
    fa_r_enc <- paste0("data:image/svg+xml;charset=utf-8;base64,", base64enc::base64encode(fa_r_raw))
    glue("<img alt=\"icon\" src=\"{fa_r_enc}\">")
  }
}
remove_header <- function(x) { gsub("<thead>.*</thead>", "", x) }
concatenate <- function(...) {
  st <- glue(..., .na = "", .sep = " ")
  st <- gsub("\\s{2,}", " ", st)
  st <- gsub("(^\\s+)|(\\s+$)", "", st)
  st <- gsub("^$", NA, st)
  return(st)
}
```

---
#######################################
############# HEADER ##################
#######################################
---

<div class = "grid-container">

---
### First Row = Header
---
<div class = "row">

<div class = "col-5">
![logo](name.png){width=35mm}

:::{.big}
`r if(params$name != "NA") params$name`
:::

<div class = "address">
```{r echo = FALSE, warning = FALSE}
lconfig <- params$config
lconfig[lconfig == "NA" | lconfig == ""] <- NA
lconfig$address3 <- concatenate(lconfig$postal_code, lconfig$city)
lconfig <- lconfig[c("address1", "address2", "address3", "mobile", "e_mail", "web", "siret")]
if (!is.na(lconfig$siret)) { lconfig$siret <- paste(":", lconfig$siret)}
lconfig <- lconfig[!is.na(lconfig)]
address = insert_fa("envelope")
mobile = insert_fa("mobile")
e_mail = insert_fa("at")
web = insert_fa("globe")
siret = "Siret" 
lconfig <- as_tibble(lconfig) %>%
  gather() %>%
  mutate(key = gsub("address\\d", "address", key)) %>%
  mutate(key = paste0("{", key, "}")) %>%
  kable() %>%
  column_spec(column = 1, width = "8mm", extra_css = "text-align:center;") %>%
  collapse_rows(valign = "top") %>%
  glue() %>%
  remove_header() %>%
  HTML()
lconfig
```
</div>

</div>


<div class = "col-7 centered">

<div class = "row">

:::{.boxheader}
Date

***

`r ifelse(params$info$date == "NA", I(format(Sys.Date(), "%d/%m/%Y")), I(params$info$date))`
:::

:::{.boxheader}
`r I(paste0("N° " , params$info$doc))`

***

`r I(params$info$ndoc)`
:::

:::{.boxheader}
N° Client

***

`r I(params$info$nclient)`
:::

</div>

<div class = "row">

```{r echo = FALSE}
lclient <- params$client
lclient[lclient == "NA" | lclient == ""] <- NA
lclient$who <- concatenate(lclient$firstname, lclient$name)
lclient$where <- concatenate(lclient$company, lclient$department)
lclient$address3 <- concatenate(lclient$postal_code, lclient$city)
lclient <- lclient[c("who", "where","address1", "address2", "address3", "mobile", "e_mail")]
lclient <- lclient[!is.na(lclient)]
lclient <- lapply(lclient, function(x) paste("<p>", x ,"</p>"))
header <- switch(tolower(params$info$doc),
                 facture = "Livraison :",
                 devis = "Client :",
                 invoice = "Delivery :",
                 quote = "Client :")
box1 <- paste0("<p class = \"headclient\">", header, 
               "</p>",paste(lclient, collapse = ""))
if (tolower(params$info$doc) %in% c("facture", "invoice")) {
  lbilling <- params$billing
  lbilling[lbilling == "NA" | lbilling == ""] <- NA
  lbilling$where <- concatenate(lbilling$company, lbilling$department)
  lbilling$address3 <- concatenate(lbilling$postal_code, lbilling$city)
  if (!is.na(lbilling$siret)) { lbilling$siret <- paste("Siret", lconfig$siret)}
  lbilling <- lbilling[c("where", "siret","address1", "address2", "address3", "mobile", "e_mail")]
  lbilling <- lbilling[!is.na(lbilling)]
  lbilling <-  lapply(lbilling, function(x) paste("<p>", x ,"</p>"))
  header <- switch(tolower(params$info$doc),
                   facture = "Facturation :",
                   invoice = "Billing :")
  box <- paste0("<div class = \"box\" id = \"bill\"><div class = \"row\"><div class = \"col-6\">",box1,"</div><div class = \"col-6\"><p class = \"headclient\">", header, "</p>",paste(lbilling, collapse = ""), "</div></div></div>")
} else {
  box <- paste0("<div class = \"box\" id = \"quote\"><div class = \"row\">",box1,"</div></div>")
}
HTML(box)
```

</div>


</div>

</div>


---
### Second row
---

<div class="row">



</div>


</div>